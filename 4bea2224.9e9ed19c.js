(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{103:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return c})),t.d(n,"metadata",(function(){return d})),t.d(n,"toc",(function(){return l})),t.d(n,"default",(function(){return p}));var a=t(4),o=t(9),r=(t(0),t(157)),i=t(187),s=t(188),c={id:"backup_restore",title:"Backup and Restore",sidebar_label:"Backup and Restore"},d={unversionedId:"administering/backup_restore",id:"administering/backup_restore",isDocsHomePage:!1,title:"Backup and Restore",description:"The steps involved with backing up your instance and restoring from backup will vary depending on how you installed Manifold and what operating system you installed it on. The content on this page is meant to get you started. It is not exhaustive, nor have the scripts below been thoroughly tested in different environments.",source:"@site/docs/administering/backup_restore.md",slug:"/administering/backup_restore",permalink:"/manifold-docusaurus/docs/administering/backup_restore",editUrl:"https://github.com/ManifoldScholar/manifold-docusaurus/edit/master/docs/administering/backup_restore.md",version:"current",sidebar_label:"Backup and Restore",sidebar:"docs",previous:{title:"Release Notes",permalink:"/manifold-docusaurus/docs/administering/updating/release_notes"},next:{title:"Troubleshooting",permalink:"/manifold-docusaurus/docs/administering/troubleshooting"}},l=[{value:"Backup Manifold",id:"backup-manifold",children:[]},{value:"Restore a Backup",id:"restore-a-backup",children:[]}],u={toc:l};function p(e){var n=e.components,t=Object(o.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},u,t,{components:n,mdxType:"MDXLayout"}),Object(r.b)("p",null,"The steps involved with backing up your instance and restoring from backup will vary depending on how you installed Manifold and what operating system you installed it on. The content on this page is meant to get you started. It is not exhaustive, nor have the scripts below been thoroughly tested in different environments."),Object(r.b)("div",{className:"admonition admonition-caution alert alert--warning"},Object(r.b)("div",{parentName:"div",className:"admonition-heading"},Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",{parentName:"h5",className:"admonition-icon"},Object(r.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),Object(r.b)("div",{parentName:"div",className:"admonition-content"},Object(r.b)("p",{parentName:"div"},"Manifold is open-source software, and you are ultimately responsible for your data. Proceed with caution and make sure you understand what the following scripts do before you run them."))),Object(r.b)("h2",{id:"backup-manifold"},"Backup Manifold"),Object(r.b)("p",null,"Manifold stores user data in two places: (1) the PostgreSQL database and (2) the file system."),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",{parentName:"div",className:"admonition-heading"},Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",{parentName:"h5",className:"admonition-icon"},Object(r.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),Object(r.b)("div",{parentName:"div",className:"admonition-content"},Object(r.b)("p",{parentName:"div"},"It is also possible for Manifold to store files in cloud storage (AWS or GCS); however, backing up cloud storage buckets is outside the scope of these instructions."))),Object(r.b)("p",null,"Backing up a Manifold instance involves backing up files and creating a database dump. The specific commands required to backup a Manifold installation depend on how Manifold was installed. Select your installation type from the options below to see sample commands you can use for backing up your instance."),Object(r.b)("p",null,"Each of the backup scripts below will create a tar archive that contains a ",Object(r.b)("inlineCode",{parentName:"p"},"dump.sql")," file and an ",Object(r.b)("inlineCode",{parentName:"p"},"uploads")," directory. These outputs can be used as inputs for the restore scripts that are described further below."),Object(r.b)("div",{className:"admonition admonition-info alert alert--info"},Object(r.b)("div",{parentName:"div",className:"admonition-heading"},Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",{parentName:"h5",className:"admonition-icon"},Object(r.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),Object(r.b)("div",{parentName:"div",className:"admonition-content"},Object(r.b)("p",{parentName:"div"},"If you downloaded one of our operating system packages for Centos or Ubuntu, follow the \u201cPackage Install\u201d instructions. The \u201cSource Install\u201d instructions assumes that services are managed by systemd in an Ubuntu environment."))),Object(r.b)(i.a,{groupId:"install-type",defaultValue:"package",values:[{label:"Package Install",value:"package"},{label:"Source Install",value:"source"}],mdxType:"Tabs"},Object(r.b)(s.a,{value:"package",mdxType:"TabItem"},Object(r.b)("p",null,"Use this Bash script as a starting point for automating your instance backups. This script will need to be run as root."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\n# Define directories\nBACKUP_DIR=/var/opt/manifold/backups/`date +"%m-%d-%y"`\nBACKUP_STAGING=$BACKUP_DIR/staged\nBACKUP_FILE=$BACKUP_DIR/manifold-backup-`date +"%m-%d-%y-%s"`.tar\nBACKUP_DB_HOST=/var/opt/manifold/postgresql\nBACKUP_DB_PORT=3034\nBACKUP_DB_USER=manifold\nBACKUP_FILES_ROOT=/var/opt/manifold/api\n\n# Create the staging directory (and parents) as the manifold user.\nsu - manifold -c "mkdir -p $BACKUP_STAGING"\n\n# Dump the database to the staging directory\nsu - manifold -c "/opt/manifold/embedded/bin/pg_dump \\\n  --user=$BACKUP_DB_USER \\\n  --port=$BACKUP_DB_PORT \\\n  --host=$BACKUP_DB_HOST manifold_production > $BACKUP_STAGING/dump.sql"\n\n# Backup the uploads directory\ncd $BACKUP_FILES_ROOT\ntar -cvf $BACKUP_FILE uploads\n\n# Add the SQL dump to the tar archive\ncd $BACKUP_STAGING\ntar -rvf $BACKUP_FILE dump.sql\ncd $BACKUP_DIR\n\n# Clean up the staging directory.\nsu - manifold -c "rm -rf $BACKUP_STAGING"\n\n# Output backup path\necho "Backup has been created at $BACKUP_FILE"\n'))),Object(r.b)(s.a,{value:"source",mdxType:"TabItem"},Object(r.b)("p",null,"Use this Bash script as a starting point for automating your instance backups. This example assumes that your instance is installed at ",Object(r.b)("inlineCode",{parentName:"p"},"/home/manifold/deploy/current")," and that the files are owned by a ",Object(r.b)("inlineCode",{parentName:"p"},"manifold")," user."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\n# These should be set in the application user\'s environment.\n#RAILS_DB_NAME=\n#RAILS_DB_PASS=\n#RAILS_DB_USER=\n\nUSER_DIR=/home/manifold\nBACKUP_DIR=$USER_DIR/backups/`date +"%m-%d-%y"`\nBACKUP_STAGING=$BACKUP_DIR/staged\nBACKUP_FILE=$BACKUP_DIR/manifold-backup-`date +"%m-%d-%y-%s"`.tar\nBACKUP_DB_HOST=localhost\nBACKUP_DB_PORT=5432\nBACKUP_FILES_ROOT=/home/manifold/deploy/shared/api/public/\nPG_URL="postgres://$RAILS_DB_USER:$RAILS_DB_PASS@$BACKUP_DB_HOST:$BACKUP_DB_PORT/$RAILS_DB_NAME"\n\n# Create the staging directory (and parents) as the manifold user.\necho "Creating the staging directory at $BACKUP_STAGING..."\nmkdir -p $BACKUP_STAGING\n\n# Dump the database to the staging directory\necho "Creating a database dump..."\npg_dump $PG_URL > $BACKUP_STAGING/dump.sql\n\n# Backup the uploads directory\necho "Creating a tar archive..."\ncd $BACKUP_FILES_ROOT\ntar -cf $BACKUP_FILE --transform=s/system/uploads/ system/\n\n# Add the SQL dump to the tar archive\necho "Adding the dump to the archive..."\ncd $BACKUP_STAGING\ntar -rf $BACKUP_FILE dump.sql\ncd $BACKUP_DIR\n\n# Clean up the staging directory.\necho "Cleaning the staging dir..."\nrm -rf $BACKUP_STAGING\n\n# Output backup path\necho "Backup has been created at $BACKUP_FILE"\n')))),Object(r.b)("h2",{id:"restore-a-backup"},"Restore a Backup"),Object(r.b)("p",null,"The following scripts take a single input, which is the path to a tar archive. That archive should include a database dump called ",Object(r.b)("inlineCode",{parentName:"p"},"dump.sql")," and a directory called ",Object(r.b)("inlineCode",{parentName:"p"},"uploads")," that includes attachment data. The backup scripts above will produce an archive that conforms to this specification."),Object(r.b)("p",null,"Assuming you call the restore script ",Object(r.b)("inlineCode",{parentName:"p"},"manifold-restore.sh")," and you were in a directory with a backup generated by the backup script above, you would restore with this command:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},"./manifold-restore.sh ./restore.sh manifold-backup-11-17-20-1605640139.tar\n")),Object(r.b)(i.a,{groupId:"install-type",defaultValue:"package",values:[{label:"Package Install",value:"package"},{label:"Source Install",value:"source"}],mdxType:"Tabs"},Object(r.b)(s.a,{value:"package",mdxType:"TabItem"},Object(r.b)("p",null,"This script will need to be run as root."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nRESTORE_DIR=/var/opt/manifold/backups/restore-staging\nRESTORE_ARCHIVE_PATH=$1\nRESTORE_ARCHIVE_FILE=$(basename $RESTORE_ARCHIVE_PATH)\nDB_HOST=/var/opt/manifold/postgresql\nDB_PORT=3034\nDB_USER=manifold\nDB_NAME=manifold_production\nBACKUP_FILES_ROOT=/var/opt/manifold/api\nTOKEN=$(cat /dev/urandom | tr -dc \'a-zA-Z0-9\' | fold -w 32 | head -n 1)\n\necho "Creating the restore staging directory at $RESTORE_DIR..."\nsu - manifold -c "mkdir -p $RESTORE_DIR"\n\necho "Extracting the restore archive..."\ncp $RESTORE_ARCHIVE_PATH $RESTORE_DIR/\ncd $RESTORE_DIR\ntar -xf $RESTORE_ARCHIVE_FILE\n\necho "Checking for an existing directory at $BACKUP_FILES_ROOT/uploads..."\nif [ -d $BACKUP_FILES_ROOT/uploads ]\nthen\n    echo "$BACKUP_FILES_ROOT/uploads exists..."\n    echo "Moving $BACKUP_FILES_ROOT/uploads to $BACKUP_FILES_ROOT/upload-bak-$TOKEN"\n    mv $BACKUP_FILES_ROOT/uploads $BACKUP_FILES_ROOT/uploads-bak-$TOKEN\nfi\n\necho "Restoring uploads dir..."\nmv uploads $BACKUP_FILES_ROOT/\n\necho "Backup existing DB to ~/manifold_production_dump-$TOKEN.sql"\nsu - manifold -c "/opt/manifold/embedded/bin/pg_dump \\\n  --user=$DB_USER \\\n  --port=$DB_PORT \\\n  --host=$DB_HOST manifold_production > ~/manifold_production_dump-$TOKEN.sql"\n\necho "Stopping manifold services..."\nmanifold-ctl stop\n\necho "Starting postgresql..."\nmanifold-ctl start postgresql\n\necho "Dropping existing database..."\nDISABLE_DATABASE_ENVIRONMENT_CHECK=1 manifold-api db:drop\n\necho "Create new database..."\nmanifold-api db:create\n\necho "Importing database dump..."\nmanifold-psql $DB_NAME < dump.sql\n\necho "Starting services..."\nmanifold-ctl start\n\necho "Cleaning up the restore staging directory..."\nsu - manifold -c "rm -rf $RESTORE_DIR"\n\necho "Restore complete."\necho "You should reindex the content on your instance with this command:"\necho "  manifold-api manifold:search:reindex"\n'))),Object(r.b)(s.a,{value:"source",mdxType:"TabItem"},Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\n# These should be set in the application user\'s environment.\n#RAILS_DB_NAME=\n#RAILS_DB_PASS=\n#RAILS_DB_USER=\n\nUSER_DIR=/home/manifold\nCURRENT_DIR=$USER_DIR/deploy/current\nRESTORE_DIR=$USER_DIR/backups/restore-staging\nRESTORE_ARCHIVE_PATH=$1\nRESTORE_ARCHIVE_FILE=$(basename $RESTORE_ARCHIVE_PATH)\nBACKUP_DB_HOST=localhost\nBACKUP_DB_PORT=5432\nBACKUP_FILES_ROOT=/home/manifold/deploy/shared/api/public\nPG_URL="postgres://$RAILS_DB_USER:$RAILS_DB_PASS@$BACKUP_DB_HOST:$BACKUP_DB_PORT/$RAILS_DB_NAME"\nTOKEN=$(cat /dev/urandom | tr -dc \'a-zA-Z0-9\' | fold -w 32 | head -n 1)\n\necho "Creating the restore staging directory at $RESTORE_DIR..."\nmkdir -p $RESTORE_DIR\n\necho "Extracting the restore archive..."\ncp $RESTORE_ARCHIVE_PATH $RESTORE_DIR/\ncd $RESTORE_DIR\ntar -xf $RESTORE_ARCHIVE_FILE\n\necho "Checking for an existing directory at $BACKUP_FILES_ROOT/system..."\nif [ -d $BACKUP_FILES_ROOT/system ]\nthen\n    echo "$BACKUP_FILES_ROOT/system exists..."\n    echo "Moving $BACKUP_FILES_ROOT/system to $BACKUP_FILES_ROOT/system-bak-$TOKEN"\n    mv $BACKUP_FILES_ROOT/system $BACKUP_FILES_ROOT/system-bak-$TOKEN\nfi\n\necho "Restoring uploads dir to $BACKUP_FILES_ROOT/system..."\nmv uploads $BACKUP_FILES_ROOT/system\n\necho "Backup existing DB to ~/manifold_production_dump-$TOKEN.sql"\npg_dump $PG_URL > ~/manifold_production_dump-$TOKEN.sql\n\necho "Stopping manifold services..."\nsudo systemctl stop manifold\n\necho "Dropping existing database..."\ncd $CURRENT_DIR/api\nDISABLE_DATABASE_ENVIRONMENT_CHECK=1 rails db:drop\n\necho "Create new database..."\ncd $CURRENT_DIR/api\nrails db:create\n\necho "Importing database dump..."\ncd $RESTORE_DIR\npsql $PG_URL < dump.sql\n\necho "Starting services..."\nsudo systemctl start manifold\n\necho "Cleaning up the restore staging directory..."\nrm -rf $RESTORE_DIR\n\necho "Restore complete."\necho "You should reindex the content on your instance with these commands:"\necho "  cd $CURRENT_DIR/api"\necho "  rails manifold:search:reindex"\n')))))}p.isMDXComponent=!0},157:function(e,n,t){"use strict";t.d(n,"a",(function(){return u})),t.d(n,"b",(function(){return b}));var a=t(0),o=t.n(a);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var d=o.a.createContext({}),l=function(e){var n=o.a.useContext(d),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},u=function(e){var n=l(e.components);return o.a.createElement(d.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return o.a.createElement(o.a.Fragment,{},n)}},m=o.a.forwardRef((function(e,n){var t=e.components,a=e.mdxType,r=e.originalType,i=e.parentName,d=c(e,["components","mdxType","originalType","parentName"]),u=l(t),m=a,b=u["".concat(i,".").concat(m)]||u[m]||p[m]||r;return t?o.a.createElement(b,s(s({ref:n},d),{},{components:t})):o.a.createElement(b,s({ref:n},d))}));function b(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var r=t.length,i=new Array(r);i[0]=m;var s={};for(var c in n)hasOwnProperty.call(n,c)&&(s[c]=n[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var d=2;d<r;d++)i[d]=t[d];return o.a.createElement.apply(null,i)}return o.a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},159:function(e,n,t){"use strict";function a(e){var n,t,o="";if("string"==typeof e||"number"==typeof e)o+=e;else if("object"==typeof e)if(Array.isArray(e))for(n=0;n<e.length;n++)e[n]&&(t=a(e[n]))&&(o&&(o+=" "),o+=t);else for(n in e)e[n]&&(o&&(o+=" "),o+=n);return o}n.a=function(){for(var e,n,t=0,o="";t<arguments.length;)(e=arguments[t++])&&(n=a(e))&&(o&&(o+=" "),o+=n);return o}},174:function(e,n,t){"use strict";var a=t(0),o=t(177);n.a=function(){var e=Object(a.useContext)(o.a);if(null==e)throw new Error("`useUserPreferencesContext` is used outside of `Layout` Component.");return e}},177:function(e,n,t){"use strict";var a=t(0),o=Object(a.createContext)(void 0);n.a=o},187:function(e,n,t){"use strict";var a=t(0),o=t.n(a),r=t(174),i=t(159),s=t(64),c=t.n(s),d=37,l=39;n.a=function(e){var n=e.lazy,t=e.block,s=e.defaultValue,u=e.values,p=e.groupId,m=e.className,b=Object(r.a)(),h=b.tabGroupChoices,f=b.setTabGroupChoices,_=Object(a.useState)(s),O=_[0],g=_[1],R=a.Children.toArray(e.children);if(null!=p){var v=h[p];null!=v&&v!==O&&u.some((function(e){return e.value===v}))&&g(v)}var E=function(e){g(e),null!=p&&f(p,e)},y=[];return o.a.createElement("div",null,o.a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:Object(i.a)("tabs",{"tabs--block":t},m)},u.map((function(e){var n=e.value,t=e.label;return o.a.createElement("li",{role:"tab",tabIndex:0,"aria-selected":O===n,className:Object(i.a)("tabs__item",c.a.tabItem,{"tabs__item--active":O===n}),key:n,ref:function(e){return y.push(e)},onKeyDown:function(e){!function(e,n,t){switch(t.keyCode){case l:!function(e,n){var t=e.indexOf(n)+1;e[t]?e[t].focus():e[0].focus()}(e,n);break;case d:!function(e,n){var t=e.indexOf(n)-1;e[t]?e[t].focus():e[e.length-1].focus()}(e,n)}}(y,e.target,e)},onFocus:function(){return E(n)},onClick:function(){E(n)}},t)}))),n?Object(a.cloneElement)(R.filter((function(e){return e.props.value===O}))[0],{className:"margin-vert--md"}):o.a.createElement("div",{className:"margin-vert--md"},R.map((function(e,n){return Object(a.cloneElement)(e,{key:n,hidden:e.props.value!==O})}))))}},188:function(e,n,t){"use strict";var a=t(0),o=t.n(a);n.a=function(e){var n=e.children,t=e.hidden,a=e.className;return o.a.createElement("div",{role:"tabpanel",hidden:t,className:a},n)}}}]);